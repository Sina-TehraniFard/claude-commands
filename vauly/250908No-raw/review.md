---
description: "品質レビュー"
argument-hint: "[source files or patterns]"
allowed-tools: "Read, Glob, Grep, Task, Bash(git:*, test:*), mcp__report-manager__*"
---

# /review

対象コード「$ARGUMENTS」の品質レビューを実行します。

## Stage 1: Foundation Metrics Collection

**以下の4つのTaskを同時に実行してください**：

1. **基本メトリクス収集**：
   - ファイル特定と行数
   - 関数/クラス数
   - テストファイル確認

2. **構造複雑度測定**：
   - 循環的複雑度
   - ネストレベル（最大階層数）
   - 関数長
   - **メソッド呼び出し階層数**

3. **TDD品質確認**：
   - テスト存在確認
   - テストと実装の対応
   - Red-Green-Refactorの形跡

4. **Git状態確認**：
   - 現在のブランチ
   - 変更ファイル
   - コミット履歴

**重要**: 単一のメッセージで4つのTask toolを呼び出してください。

## Stage 2: Code Quality Assessment

**以下の3つのTaskを同時に実行してください**：

1. **設計原則評価（KISS重視）**：
   - **KISS原則**: 適切なシンプルさの確認
   - DRY原則
   - YAGNI原則
   - 早期リターン/ガード節

2. **コード品質評価**：
   - 命名の明確性
   - エラーハンドリング
   - マジックナンバー検出
   - **コメントの必要性**: 自己説明的コードの度合い

3. **セキュリティ基本チェック**：
   - ハードコード認証情報
   - 入力検証
   - SQLインジェクション
   - XSS脆弱性

**重要**: 単一のメッセージで3つのTask toolを呼び出してください。

## Stage 3: Cognitive Integration Analysis

**Stage 1-2の結果を統合した認知心理学的評価を実行**：

**以下の2つのTaskを順次実行してください**：

1. **認知的複雑度統合評価**：
   - **Miller の法則検証**: Stage 1の構造複雑度と組み合わせた概念数測定
   - **抽象化適切性**: 単一責任原則とKISS原則の矛盾解決
   - **認知的結合度**: 密結合な処理の統合適切性判定

2. **理解容易性統合判定**：
   - **新規開発者観点**: Stage 2の品質評価を基にした初見理解度
   - **デバッグ追跡性**: メソッド階層とエラーハンドリングの組み合わせ評価
   - **保守時認知負荷**: 変更時の影響範囲把握容易性

**矛盾解決ルール適用**: 複数の評価が競合した場合は認知的理解容易性を優先

## Stage 4: Test Quality Review

TDD実装の品質を評価：

**以下の2つのTaskを同時に実行してください**：

1. **テストカバレッジ分析**：
   - ハッピーパスカバレッジ
   - エッジケースカバレッジ
   - エラーケースカバレッジ
   - 未テスト箇所の特定

2. **テスト品質評価**：
   - Given-When-Then構造
   - アサーションの適切性
   - テストの独立性
   - テスト実行時間

## Stage 5: Unified Actionable Feedback

**重み付き統合評価による改善提案**：

### 📊 統合品質スコア
```
総合スコア = (認知負荷適合度 × 40%) + (KISS適合度 × 30%) + 
            (コード品質 × 20%) + (TDD品質 × 10%)
```

### ✅ 統合適合（現状維持推奨）
- **認知的負荷**: 7±2制限内での適切な概念管理
- **KISS-認知統合**: シンプルさと理解容易性の両立
- **構造的健全性**: 循環複雑度と認知複雑度の両方が適切
- **保守性**: 現在の設計パターンの維持価値

### 🔴 P0: 緊急対応（認知的理解困難）
- **認知負荷スコア < 60**: 他の評価に関係なく緊急改善
- **Miller の法則大幅超過**: 同時把握概念数13個以上
- **重大な矛盾**: KISS適合だが認知負荷極大の場合

### 🟡 P1: 推奨対応（バランス改善）
- **部分的矛盾解決**: 単一責任とKISSの適切なバランス調整
- **認知的最適化**: メソッド間ジャンプの削減
- **可読性向上**: 新規開発者の理解を助ける改善

### 🔄 リファクタリング候補（統合的観点）
- **認知的統合**: 密結合な処理の適切な統合
- **過剰抽象化解決**: 不必要な分割の簡素化
- **階層最適化**: 3層を超えるネスト構造の平坦化

## Stage 6: Integrated Report & Save

以下を順次実行：

1. **統合レポート作成**：
   - **統合品質スコア**: 重み付き総合評価
   - **矛盾解決結果**: 競合した評価項目の統合結論
   - **認知的適合性**: Miller の法則・SLAP適合度
   - **アクション優先度**: P0緊急 → P1推奨 → リファクタリングの順
   - **TDD品質**: Red/Green/Refactor状態

2. **MCP保存**：
   - mcp__report-manager__create_report
   - title: "統合認知品質レビュー - [機能名]"
   - type: "review"
   - phase: "review"
   - tags: ["統合評価", "矛盾解決", "認知心理学", "KISS原則"]

---

## 📋 統合評価基準

### 認知的複雑度統合スコア
| スコア | 判定 | Miller の法則 | KISS適合 | アクション |
|--------|------|---------------|----------|------------|
| 90-100 | 🟢 優秀 | 5-7概念 | 完全適合 | 現状維持 |
| 80-89  | 🟢 良好 | 8-9概念 | 適合 | 軽微改善 |
| 70-79  | 🟡 普通 | 10-12概念 | 部分適合 | P1対応 |
| 60-69  | 🟠 要改善 | 13-15概念 | 要改善 | P1対応 |
| 60未満 | 🔴 緊急 | 16概念以上 | 不適合 | P0対応 |

### 矛盾解決優先順位
1. **認知的理解容易性** (最優先)
2. **KISS原則適合性**
3. **構造的品質**
4. **単一責任原則**

### 統合判定パターン
```
IF (認知負荷 >= 80 AND KISS違反) THEN "認知的優先で統合推奨"
IF (認知負荷 < 60) THEN "緊急改善" 
IF (Miller法則適合 AND KISS適合 AND 単一責任違反) THEN "現状維持"
```