---
description: "テスト品質評価"
argument-hint: "[test file patterns] | **/*.test.{js,ts}"
allowed-tools: "Read, Glob, Grep, Task, Bash(git:*, test:*), mcp__report-manager__*"
---

# /unit-test-review

対象テスト「$ARGUMENTS」の品質評価を実行します。

## Stage 1: Foundation Test Metrics Collection

**以下の4つのTaskを同時に実行してください**：

1. **テストファイル特定**：
   - Globでテストファイル検索
   - デフォルト: `**/*.test.{js,ts}` または `**/*.spec.{js,ts}`
   - ファイル数とテスト数確認

2. **環境・構造確認**：
   - Gitブランチ取得
   - テストフレームワーク検出
   - **テストファイル構造複雑度**: ネストレベル、describe階層数

3. **基本品質メトリクス**：
   - テストと実装の対応
   - Given-When-Then構造確認
   - アサーション適切性

4. **Git・実行環境状態**：
   - 変更ファイル確認
   - テストコマンド検証
   - 並列実行可能性

**重要**: 単一のメッセージで4つのTask toolを呼び出してください。

## Stage 2: Test Quality Assessment

**以下の3つのTaskを同時に実行してください**：

1. **TDD品質評価（KISS重視）**：
   - **KISS原則**: 適切なテストシンプルさ
   - **早期リターン/ガード節**: テスト条件の明確性

2. **テストカバレッジ・構造評価**：
   - ハッピーパス/エッジケース/エラーケース
   - **テスト独立性**: テスト間依存の検出
   - **決定性評価**: 非決定的要素検出

3. **セキュリティ・パフォーマンス基本チェック**：
   - テストデータの機密情報確認
   - 実行時間測定
   - モック化適切性

**重要**: 単一のメッセージで3つのTask toolを呼び出してください。

## Stage 3: Cognitive Integration Analysis

**Stage 1-2の結果を統合した認知心理学的評価を実行**：

**以下の2つのTaskを順次実行してください**：

1. **認知的複雑度統合評価**：
   - **Miller の法則検証**: Stage 1の構造複雑度と組み合わせた概念数測定
   - **抽象化適切性**: テストの抽象化レベル統一とKISS原則の矛盾解決
   - **認知的結合度**: Given-When-Then間の論理的つながり

2. **理解容易性統合判定**：
   - **新規開発者観点**: Stage 2の品質評価を基にした初見理解度
   - **デバッグ追跡性**: テスト失敗時の原因特定容易性
   - **保守時認知負荷**: テスト変更時の影響範囲把握容易性

**矛盾解決ルール適用**: 複数の評価が競合した場合は認知的理解容易性を優先

## Stage 4: Test Performance Review

テスト実行品質とメトリクス評価：

**以下の2つのTaskを同時に実行してください**：

1. **実行効率分析**：
   - テスト実行時間測定と判定
   - ボトルネック特定
   - 並列実行最適化候補

2. **品質メトリクス統合**：
   - カバレッジ推定値
   - 重複度スコア
   - テスト密度（実装コード行/テストコード行）

## Stage 5: Unified Actionable Feedback

**重み付き統合評価による改善提案**：

### 📊 統合品質スコア
```
総合スコア = (認知負荷適合度 × 45%) + (TDD品質 × 35%) + 
            (テスト効率 × 20%)
```

### ✅ 統合適合（現状維持推奨）
- **認知的負荷**: 7±2制限内での適切な概念管理
- **TDD-認知統合**: Given-When-Then構造と理解容易性の両立
- **構造的健全性**: テスト複雑度と認知複雑度の両方が適切
- **保守性**: 現在のテスト設計パターンの維持価値

### 🔴 P0: 緊急対応（認知的理解困難）
- **認知負荷スコア < 60**: 他の評価に関係なく緊急改善
- **Miller の法則大幅超過**: 同時把握概念数13個以上
- **重大な矛盾**: TDD適合だが認知負荷極大の場合

### 🟡 P1: 推奨対応（バランス改善）
- **部分的矛盾解決**: Given-When-Thenと認知負荷の適切なバランス調整
- **認知的最適化**: テストケース間ジャンプの削減
- **可読性向上**: 新規開発者のテスト理解を助ける改善

### 🔄 リファクタリング候補（統合的観点）
- **認知的統合**: 関連テストケースの適切な統合
- **過剰分割解決**: 不必要なテスト分割の簡素化
- **階層最適化**: 3層を超えるdescribe構造の平坦化

## Stage 6: Integrated Report & Save

以下を順次実行：

1. **統合レポート作成**：
   - **統合品質スコア**: 重み付き総合評価
   - **矛盾解決結果**: 競合した評価項目の統合結論
   - **認知的適合性**: Miller の法則・SLAP適合度
   - **アクション優先度**: P0緊急 → P1推奨 → リファクタリングの順
   - **TDD品質**: Red/Green/Refactor状態とカバレッジ

2. **MCP保存**：
   - mcp__report-manager__create_report
   - title: "統合認知テスト品質評価 - [機能名]"
   - type: "test"
   - phase: "test-review"
   - tags: ["統合評価", "矛盾解決", "認知心理学", "TDD品質"]

---

## 📋 統合評価基準

### 認知的複雑度統合スコア
| スコア | 判定 | Miller の法則 | TDD適合 | アクション |
|--------|------|---------------|---------|------------|
| 90-100 | 🟢 優秀 | 5-7概念 | 完全適合 | 現状維持 |
| 80-89  | 🟢 良好 | 8-9概念 | 適合 | 軽微改善 |
| 70-79  | 🟡 普通 | 10-12概念 | 部分適合 | P1対応 |
| 60-69  | 🟠 要改善 | 13-15概念 | 要改善 | P1対応 |
| 60未満 | 🔴 緊急 | 16概念以上 | 不適合 | P0対応 |

### 矛盾解決優先順位
1. **認知的理解容易性** (最優先)
2. **TDD品質適合性**
3. **実行効率性**
4. **構造的一貫性**

### 統合判定パターン
```
IF (認知負荷 >= 80 AND TDD適合) THEN "認知的優先で最適化推奨"
IF (認知負荷 < 60) THEN "緊急改善" 
IF (Miller法則適合 AND TDD適合 AND 効率違反) THEN "現状維持"
```